{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/DELL/Desktop/my-flux-saas/app/api/fetch_result/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\r\nimport type { NextRequest } from \"next/server\";\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const { pollingUrl } = await req.json();\r\n    if (!pollingUrl) {\r\n      return NextResponse.json(\r\n        { error: \"Missing pollingUrl\" },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const apiKey = process.env.BFL_API_KEY;\r\n    if (!apiKey) {\r\n      return NextResponse.json(\r\n        { error: \"Server misconfiguration\" },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    const resp = await fetch(pollingUrl, {\r\n      method: \"GET\",\r\n      headers: {\r\n        \"x-key\": apiKey,\r\n        \"Content-Type\": \"application/json\",\r\n      },\r\n    });\r\n\r\n    // 204 = still processing\r\n    if (resp.status === 204) {\r\n      return NextResponse.json({ ready: false }, { status: 200 });\r\n    }\r\n\r\n    const json = await resp.json().catch(() => null);\r\n    if (!json) {\r\n      return NextResponse.json(\r\n        { error: \"Failed to parse polling response\" },\r\n        { status: 502 }\r\n      );\r\n    }\r\n\r\n    // Try to extract possible image results\r\n    const imageUrl =\r\n      json?.result?.sample ||\r\n      json?.result?.outputs?.[0]?.url ||\r\n      json?.image_url ||\r\n      json?.data?.url ||\r\n      (typeof json?.output_base64 === \"string\"\r\n        ? `data:image/png;base64,${json.output_base64}`\r\n        : null);\r\n\r\n    // If image found, return it\r\n    if (imageUrl) {\r\n      return NextResponse.json({ imageUrl, ready: true }, { status: 200 });\r\n    }\r\n\r\n    // Sometimes the API returns a \"completed\" status but no image yet\r\n    const status = (json?.status || json?.state || \"\").toLowerCase();\r\n\r\n    if (\r\n      status.includes(\"ready\") ||\r\n      status.includes(\"succeeded\") ||\r\n      status.includes(\"completed\")\r\n    ) {\r\n      return NextResponse.json(\r\n        { ready: true, imageUrl: null, raw: json },\r\n        { status: 200 }\r\n      );\r\n    }\r\n\r\n    // Still processing\r\n    return NextResponse.json({ ready: false, raw: json }, { status: 200 });\r\n  } catch (err) {\r\n    console.error(\"Error in /api/fetch_result:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Internal server error\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAGO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,EAAE,UAAU,EAAE,GAAG,MAAM,IAAI,IAAI;QACrC,IAAI,CAAC,YAAY;YACf,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAqB,GAC9B;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,QAAQ,GAAG,CAAC,WAAW;QACtC,IAAI,CAAC,QAAQ;YACX,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAA0B,GACnC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,OAAO,MAAM,MAAM,YAAY;YACnC,QAAQ;YACR,SAAS;gBACP,SAAS;gBACT,gBAAgB;YAClB;QACF;QAEA,yBAAyB;QACzB,IAAI,KAAK,MAAM,KAAK,KAAK;YACvB,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAM,GAAG;gBAAE,QAAQ;YAAI;QAC3D;QAEA,MAAM,OAAO,MAAM,KAAK,IAAI,GAAG,KAAK,CAAC,IAAM;QAC3C,IAAI,CAAC,MAAM;YACT,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;YAAmC,GAC5C;gBAAE,QAAQ;YAAI;QAElB;QAEA,wCAAwC;QACxC,MAAM,WACJ,MAAM,QAAQ,UACd,MAAM,QAAQ,SAAS,CAAC,EAAE,EAAE,OAC5B,MAAM,aACN,MAAM,MAAM,OACZ,CAAC,OAAO,MAAM,kBAAkB,WAC5B,CAAC,sBAAsB,EAAE,KAAK,aAAa,EAAE,GAC7C,IAAI;QAEV,4BAA4B;QAC5B,IAAI,UAAU;YACZ,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE;gBAAU,OAAO;YAAK,GAAG;gBAAE,QAAQ;YAAI;QACpE;QAEA,kEAAkE;QAClE,MAAM,SAAS,CAAC,MAAM,UAAU,MAAM,SAAS,EAAE,EAAE,WAAW;QAE9D,IACE,OAAO,QAAQ,CAAC,YAChB,OAAO,QAAQ,CAAC,gBAChB,OAAO,QAAQ,CAAC,cAChB;YACA,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAM,UAAU;gBAAM,KAAK;YAAK,GACzC;gBAAE,QAAQ;YAAI;QAElB;QAEA,mBAAmB;QACnB,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;YAAO,KAAK;QAAK,GAAG;YAAE,QAAQ;QAAI;IACtE,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAwB,GACjC;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}