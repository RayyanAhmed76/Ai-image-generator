{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAGA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { prisma } from \"./prisma\";\r\n\r\nexport async function getCurrentUser(req: NextRequest) {\r\n  const token = req.cookies.get(\"flux_auth\")?.value;\r\n  \r\n  if (!token) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // Find token in database\r\n    const tokenRecord = await prisma.token.findUnique({\r\n      where: { token },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!tokenRecord) {\r\n      return null;\r\n    }\r\n\r\n    // Check if token is expired\r\n    if (new Date() > tokenRecord.expiresAt) {\r\n      // Delete expired token\r\n      await prisma.token.delete({ where: { id: tokenRecord.id } });\r\n      return null;\r\n    }\r\n\r\n    return tokenRecord.user;\r\n  } catch (error) {\r\n    console.error(\"Error getting current user:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserUsageCount(userId: string): Promise<number> {\r\n  try {\r\n    const count = await prisma.usage.count({\r\n      where: { userId },\r\n    });\r\n    return count;\r\n  } catch (error) {\r\n    console.error(\"Error getting usage count:\", error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,eAAe,eAAe,GAAgB;IACnD,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAE5C,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IAEA,IAAI;QACF,yBAAyB;QACzB,MAAM,cAAc,MAAM,+IAAM,CAAC,KAAK,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAM;YACf,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO;QACT;QAEA,4BAA4B;QAC5B,IAAI,IAAI,SAAS,YAAY,SAAS,EAAE;YACtC,uBAAuB;YACvB,MAAM,+IAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,YAAY,EAAE;gBAAC;YAAE;YAC1D,OAAO;QACT;QAEA,OAAO,YAAY,IAAI;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF;AAEO,eAAe,kBAAkB,MAAc;IACpD,IAAI;QACF,MAAM,QAAQ,MAAM,+IAAM,CAAC,KAAK,CAAC,KAAK,CAAC;YACrC,OAAO;gBAAE;YAAO;QAClB;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/app/api/check-usage/route.ts"],"sourcesContent":["// app/api/check-usage/route.ts\nimport { NextRequest, NextResponse } from \"next/server\";\nimport Stripe from \"stripe\";\nimport { getCurrentUser, getUserUsageCount } from \"../../../lib/auth\";\nimport { prisma } from \"../../../lib/prisma\";\n\nconst FREE_TRIES_LIMIT = 2;\n\n\nconst stripe =\n  process.env.STRIPE_SECRET_KEY && process.env.STRIPE_SECRET_KEY.length > 0\n    ? new Stripe(process.env.STRIPE_SECRET_KEY, { apiVersion: (\"2022-11-15\" as any) })\n    : null;\n\ntype SubscriptionShape = {\n  status?: string | null;\n  current_period_end?: number | string | null;\n  trial_end?: number | string | null;\n  plan_name?: string | null;\n};\n\nexport async function GET(req: NextRequest) {\n  try {\n    const user = await getCurrentUser(req);\n\n    if (!user) {\n      return NextResponse.json({ authenticated: false }, { status: 401 });\n    }\n\n    \n    const usageCount = await getUserUsageCount(user.id);\n    // default isSubscribed is from user flag, but we'll reconcile with Stripe/subscription below\n    let isSubscribed = !!(user as any).isSubscribed;\n\n    // finding latest payment row of current user (contains stripeCustomerId, subscriptionId, etc.)\n    let lastPayment = null;\n    try {\n      lastPayment = await prisma.payment.findFirst({\n        where: { userId: user.id },\n        orderBy: { createdAt: \"desc\" },\n      });\n    } catch (err) {\n      console.warn(\"prisma.payment lookup failed â€” check model name and migration\", err);\n      lastPayment = null;\n    }\n\n    \n    const dbSubscriptionId =\n      (lastPayment as any)?.subscriptionId ||\n      (lastPayment as any)?.subscription_id ||\n      (user as any).subscriptionId ||\n      (user as any).subscription_id ||\n      null;\n\n    const dbCustomerId =\n      (lastPayment as any)?.stripeCustomerId ||\n      (lastPayment as any)?.stripe_customer_id ||\n      (user as any).stripeCustomerId ||\n      (user as any).stripe_customer_id ||\n      null;\n\n    \n    let subscription: SubscriptionShape | null = null;\n\n    // If we have a db subscription id and stripe configured, try to retrieve that subscription directly\n    if (stripe && dbSubscriptionId) {\n      try {\n        // retrieve subscription from stripe\n        const stripeSub = await stripe.subscriptions.retrieve(dbSubscriptionId as string, {\n          expand: [\"items.data.price\"],\n        });\n        const anySub = stripeSub as any;\n\n\n        const status = anySub.status ?? null;\n        const subscribedFlag = status === \"active\" || status === \"trialing\";\n\n\n        const price = anySub.items?.data?.[0]?.price;\n\n        subscription = {\n          status: status,\n          current_period_end:\n            typeof anySub.current_period_end === \"number\"\n              ? anySub.current_period_end\n              : anySub.current_period_end ?? null,\n          trial_end: anySub.trial_end ?? null,\n          plan_name: subscribedFlag\n            ? (price?.nickname || \"PRO\")\n            : \"Free\",\n        };\n\n        // mark subscribed if subscription is active or trialing\n        isSubscribed = subscribedFlag;\n      } catch (err) {\n        console.warn(\"stripe.subscriptions.retrieve failed for dbSubscriptionId\", dbSubscriptionId, err);\n        subscription = null;\n      }\n    }\n\n    // If still no subscription and we have a customer id and stripe configured, list subscriptions for customer\n    if (!subscription && stripe && dbCustomerId) {\n      try {\n        const subs = await stripe.subscriptions.list({\n          customer: dbCustomerId,\n          status: \"all\",\n          expand: [\"data.items.data.price\"],\n          limit: 10,\n        });\n\n        const pick =\n          subs.data.find((s) => s.status === \"active\" || s.status === \"trialing\") || subs.data[0] || null;\n\n        if (pick) {\n          const anyPick = pick as any;\n          const status = anyPick.status ?? null;\n          const subscribedFlag = status === \"active\" || status === \"trialing\";\n          const price = anyPick.items?.data?.[0]?.price;\n\n          subscription = {\n            status: status,\n            current_period_end:\n              typeof anyPick.current_period_end === \"number\"\n                ? anyPick.current_period_end\n                : anyPick.current_period_end ?? null,\n            trial_end: anyPick.trial_end ?? null,\n            plan_name: subscribedFlag\n              ? (price?.nickname || \"PRO\")\n              : \"Free\",\n          };\n\n          isSubscribed = subscribedFlag;\n        }\n      } catch (err) {\n        console.warn(\"stripe.subscriptions.list failed for customer\", dbCustomerId, err);\n      }\n    }\n\n\n    if (!subscription) {\n      if ((user as any).subscription) {\n        \n        const stored = (user as any).subscription as SubscriptionShape;\n        const status = stored?.status ?? null;\n        const subscribedFlag = status === \"active\" || status === \"trialing\";\n\n        subscription = {\n          status: status,\n          current_period_end: stored?.current_period_end ?? null,\n          trial_end: stored?.trial_end ?? null,\n          plan_name: subscribedFlag ? (stored?.plan_name || \"PRO\") : \"Free\",\n        };\n        isSubscribed = subscribedFlag || !!(user as any).isSubscribed;\n      } else {\n\n        subscription = (user as any).isSubscribed\n          ? { status: \"active\", current_period_end: null, trial_end: null, plan_name: \"PRO\" }\n          : { status: \"none\", current_period_end: null, trial_end: null, plan_name: \"Free\" };\n        isSubscribed = !!(user as any).isSubscribed;\n      }\n    }\n\n    const canUse = isSubscribed || usageCount < FREE_TRIES_LIMIT;\n    const limitReached = !isSubscribed && usageCount >= FREE_TRIES_LIMIT;\n\n    return NextResponse.json({\n      authenticated: true,\n      isSubscribed,\n      usageCount,\n      canUse,\n      limitReached,\n      username: user.username,\n      email: user.email,\n      subscription,\n      \n      _debug: {\n        dbSubscriptionId,\n        dbCustomerId,\n        lastPaymentId: (lastPayment as any)?.id ?? null,\n      },\n    });\n  } catch (error) {\n    console.error(\"Error checking usage:\", error);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}