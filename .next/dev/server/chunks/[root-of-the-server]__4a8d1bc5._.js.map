{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAGA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 65, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { prisma } from \"./prisma\";\r\n\r\nexport async function getCurrentUser(req: NextRequest) {\r\n  const token = req.cookies.get(\"flux_auth\")?.value;\r\n  \r\n  if (!token) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // Find token in database\r\n    const tokenRecord = await prisma.token.findUnique({\r\n      where: { token },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!tokenRecord) {\r\n      return null;\r\n    }\r\n\r\n    // Check if token is expired\r\n    if (new Date() > tokenRecord.expiresAt) {\r\n      // Delete expired token\r\n      await prisma.token.delete({ where: { id: tokenRecord.id } });\r\n      return null;\r\n    }\r\n\r\n    return tokenRecord.user;\r\n  } catch (error) {\r\n    console.error(\"Error getting current user:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserUsageCount(userId: string): Promise<number> {\r\n  try {\r\n    const count = await prisma.usage.count({\r\n      where: { userId },\r\n    });\r\n    return count;\r\n  } catch (error) {\r\n    console.error(\"Error getting usage count:\", error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,eAAe,eAAe,GAAgB;IACnD,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAE5C,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IAEA,IAAI;QACF,yBAAyB;QACzB,MAAM,cAAc,MAAM,+IAAM,CAAC,KAAK,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAM;YACf,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO;QACT;QAEA,4BAA4B;QAC5B,IAAI,IAAI,SAAS,YAAY,SAAS,EAAE;YACtC,uBAAuB;YACvB,MAAM,+IAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,YAAY,EAAE;gBAAC;YAAE;YAC1D,OAAO;QACT;QAEA,OAAO,YAAY,IAAI;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF;AAEO,eAAe,kBAAkB,MAAc;IACpD,IAAI;QACF,MAAM,QAAQ,MAAM,+IAAM,CAAC,KAAK,CAAC,KAAK,CAAC;YACrC,OAAO;gBAAE;YAAO;QAClB;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/app/api/generate/route.ts"],"sourcesContent":["\nimport { NextResponse } from \"next/server\";\nimport type { NextRequest } from \"next/server\";\nimport { getCurrentUser, getUserUsageCount } from \"../../../lib/auth\";\nimport { prisma } from \"../../../lib/prisma\";\n\ntype ReqBody = { prompt?: string; base64Image?: string };\n\nconst FREE_TRIES_LIMIT = 2;\n\nexport async function POST(req: NextRequest) {\n  try {\n    \n    const user = await getCurrentUser(req);\n    if (!user) {\n      return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\n    }\n\n    \n    if (!user.isSubscribed) {\n      \n      const usageCount = await getUserUsageCount(user.id);\n      if (usageCount >= FREE_TRIES_LIMIT) {\n        return NextResponse.json(\n          { error: \"Free trial limit reached. Please subscribe to continue.\", limitReached: true },\n          { status: 403 }\n        );\n      }\n    }\n\n    const body: ReqBody = await req.json();\n    const prompt = (body.prompt || \"\").trim();\n    const base64Image = (body.base64Image || \"\").trim();\n    if (!prompt || !base64Image) {\n      return NextResponse.json({ error: \"Missing prompt or base64Image\" }, { status: 400 });\n    }\n\n    const apiKey = process.env.BFL_API_KEY;\n    if (!apiKey) {\n      console.error(\"BFL_API_KEY not set\");\n      return NextResponse.json({ error: \"Server misconfiguration\" }, { status: 500 });\n    }\n\n    const resp = await fetch(\"https://api.bfl.ai/v1/flux-kontext-pro\", {\n      method: \"POST\",\n      headers: {\n        \"x-key\": apiKey,\n        \"Content-Type\": \"application/json\",\n      },\n      body: JSON.stringify({\n        prompt,\n        input_image: base64Image,\n        seed: 42,\n        output_format: \"png\",\n        safety_tolerance: 2,\n      }),\n    });\n\n    const json = await resp.json();\n\n    // Helper: try to find image in initial response\n    const tryExtractImage = (obj: any): string | null => {\n      if (!obj) return null;\n      if (typeof obj.image_url === \"string\" && obj.image_url) return obj.image_url;\n      if (typeof obj.output_base64 === \"string\" && obj.output_base64) return `data:image/png;base64,${obj.output_base64}`;\n      if (typeof obj.result === \"string\" && obj.result) return obj.result.startsWith(\"data:\") ? obj.result : `data:image/png;base64,${obj.result}`;\n      if (Array.isArray(obj.outputs) && obj.outputs[0]) {\n        const o = obj.outputs[0];\n        if (o.url) return o.url;\n        if (o.base64) return `data:image/png;base64,${o.base64}`;\n      }\n      if (obj?.data?.url) return obj.data.url;\n      if (obj?.data?.base64) return `data:image/png;base64,${obj.data.base64}`;\n      return null;\n    };\n\n    const image = tryExtractImage(json);\n    if (image) {\n      // Track usage for free users\n      if (!user.isSubscribed) {\n        await prisma.usage.create({\n          data: {\n            userId: user.id,\n            prompt,\n          },\n        });\n      }\n      return NextResponse.json({ image }, { status: 200 });\n    }\n\n    \n    if (typeof json?.polling_url === \"string\") {\n      if (!user.isSubscribed) {\n        await prisma.usage.create({\n          data: {\n            userId: user.id,\n            prompt,\n          },\n        });\n      }\n      return NextResponse.json({ polling_url: json.polling_url }, { status: 200 });\n    }\n\n    // Unexpected: no image and no polling URL\n    console.error(\"Unexpected response from Flux:\", json);\n    return NextResponse.json({ error: \"Unexpected response from Flux\" }, { status: 502 });\n  } catch (err) {\n    console.error(\"Error in /api/generate:\", err);\n    return NextResponse.json({ error: \"Internal server error\" }, { status: 500 });\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}