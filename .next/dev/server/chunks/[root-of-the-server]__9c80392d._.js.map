{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAGA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { prisma } from \"./prisma\";\r\n\r\nexport async function getCurrentUser(req: NextRequest) {\r\n  const token = req.cookies.get(\"flux_auth\")?.value;\r\n  \r\n  if (!token) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // Find token in database\r\n    const tokenRecord = await prisma.token.findUnique({\r\n      where: { token },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!tokenRecord) {\r\n      return null;\r\n    }\r\n\r\n    // Check if token is expired\r\n    if (new Date() > tokenRecord.expiresAt) {\r\n      // Delete expired token\r\n      await prisma.token.delete({ where: { id: tokenRecord.id } });\r\n      return null;\r\n    }\r\n\r\n    return tokenRecord.user;\r\n  } catch (error) {\r\n    console.error(\"Error getting current user:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserUsageCount(userId: string): Promise<number> {\r\n  try {\r\n    const count = await prisma.usage.count({\r\n      where: { userId },\r\n    });\r\n    return count;\r\n  } catch (error) {\r\n    console.error(\"Error getting usage count:\", error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,eAAe,eAAe,GAAgB;IACnD,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAE5C,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IAEA,IAAI;QACF,yBAAyB;QACzB,MAAM,cAAc,MAAM,+IAAM,CAAC,KAAK,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAM;YACf,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO;QACT;QAEA,4BAA4B;QAC5B,IAAI,IAAI,SAAS,YAAY,SAAS,EAAE;YACtC,uBAAuB;YACvB,MAAM,+IAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,YAAY,EAAE;gBAAC;YAAE;YAC1D,OAAO;QACT;QAEA,OAAO,YAAY,IAAI;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF;AAEO,eAAe,kBAAkB,MAAc;IACpD,IAAI;QACF,MAAM,QAAQ,MAAM,+IAAM,CAAC,KAAK,CAAC,KAAK,CAAC;YACrC,OAAO;gBAAE;YAAO;QAClB;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/app/api/verify-session/route.ts"],"sourcesContent":["// app/api/verify-session/route.ts\r\nimport { NextRequest, NextResponse } from \"next/server\";\r\nimport Stripe from \"stripe\";\r\nimport { getCurrentUser } from \"../../../lib/auth\";\r\nimport { prisma } from \"../../../lib/prisma\";\r\n\r\nexport async function GET(req: NextRequest) {\r\n  const stripeSecret = process.env.STRIPE_SECRET_KEY;\r\n  if (!stripeSecret) {\r\n    return NextResponse.json({ error: \"Stripe key not configured\" }, { status: 500 });\r\n  }\r\n\r\n  const user = await getCurrentUser(req);\r\n  if (!user) {\r\n    return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n  }\r\n\r\n  const sessionId = req.nextUrl.searchParams.get(\"session_id\");\r\n  if (!sessionId) {\r\n    return NextResponse.json({ error: \"session_id is required\" }, { status: 400 });\r\n  }\r\n\r\n  try {\r\n    const stripe = new Stripe(stripeSecret);\r\n    \r\n    // Retrieve the session from Stripe\r\n    const session = await stripe.checkout.sessions.retrieve(sessionId);\r\n    \r\n    // Check if payment was successful\r\n    if (session.payment_status === \"paid\" && session.status === \"complete\") {\r\n      // Check if we already have a payment record\r\n      const existingPayment = await prisma.payment.findUnique({\r\n        where: { stripeSessionId: sessionId },\r\n      });\r\n\r\n      if (!existingPayment) {\r\n        // Payment record doesn't exist yet, create it\r\n        const subscriptionId = session.subscription as string | null;\r\n        const customerId = session.customer as string | null;\r\n        const amountTotal = (session.amount_total || 0) / 100;\r\n\r\n        // Update user subscription status\r\n        await prisma.user.update({\r\n          where: { id: user.id },\r\n          data: {\r\n            isSubscribed: true,\r\n            subscriptionId: subscriptionId || null,\r\n          },\r\n        });\r\n\r\n        // Create payment record\r\n        await prisma.payment.create({\r\n          data: {\r\n            userId: user.id,\r\n            stripeSessionId: sessionId,\r\n            stripeCustomerId: customerId || null,\r\n            amount: amountTotal,\r\n            currency: session.currency || \"usd\",\r\n            status: \"completed\",\r\n            subscriptionId: subscriptionId || null,\r\n          },\r\n        });\r\n      }\r\n\r\n      // Refresh user data\r\n      const updatedUser = await prisma.user.findUnique({\r\n        where: { id: user.id },\r\n      });\r\n\r\n      return NextResponse.json({\r\n        verified: true,\r\n        isSubscribed: updatedUser?.isSubscribed || false,\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      verified: false,\r\n      isSubscribed: user.isSubscribed,\r\n    });\r\n  } catch (err: any) {\r\n    console.error(\"Error verifying session:\", err);\r\n    return NextResponse.json(\r\n      { error: err?.message || \"Failed to verify session\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n\r\n"],"names":[],"mappings":"AAAA,kCAAkC;;;;;AAClC;AACA;AACA;AACA;;;;;AAEO,eAAe,IAAI,GAAgB;IACxC,MAAM,eAAe,QAAQ,GAAG,CAAC,iBAAiB;IAClD,IAAI,CAAC,cAAc;QACjB,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA4B,GAAG;YAAE,QAAQ;QAAI;IACjF;IAEA,MAAM,OAAO,MAAM,IAAA,qJAAc,EAAC;IAClC,IAAI,CAAC,MAAM;QACT,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;IACpE;IAEA,MAAM,YAAY,IAAI,OAAO,CAAC,YAAY,CAAC,GAAG,CAAC;IAC/C,IAAI,CAAC,WAAW;QACd,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAyB,GAAG;YAAE,QAAQ;QAAI;IAC9E;IAEA,IAAI;QACF,MAAM,SAAS,IAAI,yLAAM,CAAC;QAE1B,mCAAmC;QACnC,MAAM,UAAU,MAAM,OAAO,QAAQ,CAAC,QAAQ,CAAC,QAAQ,CAAC;QAExD,kCAAkC;QAClC,IAAI,QAAQ,cAAc,KAAK,UAAU,QAAQ,MAAM,KAAK,YAAY;YACtE,4CAA4C;YAC5C,MAAM,kBAAkB,MAAM,+IAAM,CAAC,OAAO,CAAC,UAAU,CAAC;gBACtD,OAAO;oBAAE,iBAAiB;gBAAU;YACtC;YAEA,IAAI,CAAC,iBAAiB;gBACpB,8CAA8C;gBAC9C,MAAM,iBAAiB,QAAQ,YAAY;gBAC3C,MAAM,aAAa,QAAQ,QAAQ;gBACnC,MAAM,cAAc,CAAC,QAAQ,YAAY,IAAI,CAAC,IAAI;gBAElD,kCAAkC;gBAClC,MAAM,+IAAM,CAAC,IAAI,CAAC,MAAM,CAAC;oBACvB,OAAO;wBAAE,IAAI,KAAK,EAAE;oBAAC;oBACrB,MAAM;wBACJ,cAAc;wBACd,gBAAgB,kBAAkB;oBACpC;gBACF;gBAEA,wBAAwB;gBACxB,MAAM,+IAAM,CAAC,OAAO,CAAC,MAAM,CAAC;oBAC1B,MAAM;wBACJ,QAAQ,KAAK,EAAE;wBACf,iBAAiB;wBACjB,kBAAkB,cAAc;wBAChC,QAAQ;wBACR,UAAU,QAAQ,QAAQ,IAAI;wBAC9B,QAAQ;wBACR,gBAAgB,kBAAkB;oBACpC;gBACF;YACF;YAEA,oBAAoB;YACpB,MAAM,cAAc,MAAM,+IAAM,CAAC,IAAI,CAAC,UAAU,CAAC;gBAC/C,OAAO;oBAAE,IAAI,KAAK,EAAE;gBAAC;YACvB;YAEA,OAAO,sKAAY,CAAC,IAAI,CAAC;gBACvB,UAAU;gBACV,cAAc,aAAa,gBAAgB;YAC7C;QACF;QAEA,OAAO,sKAAY,CAAC,IAAI,CAAC;YACvB,UAAU;YACV,cAAc,KAAK,YAAY;QACjC;IACF,EAAE,OAAO,KAAU;QACjB,QAAQ,KAAK,CAAC,4BAA4B;QAC1C,OAAO,sKAAY,CAAC,IAAI,CACtB;YAAE,OAAO,KAAK,WAAW;QAA2B,GACpD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}