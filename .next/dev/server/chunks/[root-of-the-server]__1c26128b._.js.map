{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 88, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\n\n\nconst globalForPrisma = globalThis as unknown as {\n  prisma: PrismaClient | undefined;\n};\n\nexport const prisma = globalForPrisma.prisma ?? new PrismaClient();\n\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;\n\n"],"names":[],"mappings":";;;;AAAA;;AAGA,MAAM,kBAAkB;AAIjB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,6IAAY;AAEhE,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 101, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/lib/auth.ts"],"sourcesContent":["import { NextRequest } from \"next/server\";\r\nimport { prisma } from \"./prisma\";\r\n\r\nexport async function getCurrentUser(req: NextRequest) {\r\n  const token = req.cookies.get(\"flux_auth\")?.value;\r\n  \r\n  if (!token) {\r\n    return null;\r\n  }\r\n\r\n  try {\r\n    // Find token in database\r\n    const tokenRecord = await prisma.token.findUnique({\r\n      where: { token },\r\n      include: { user: true },\r\n    });\r\n\r\n    if (!tokenRecord) {\r\n      return null;\r\n    }\r\n\r\n    // Check if token is expired\r\n    if (new Date() > tokenRecord.expiresAt) {\r\n      // Delete expired token\r\n      await prisma.token.delete({ where: { id: tokenRecord.id } });\r\n      return null;\r\n    }\r\n\r\n    return tokenRecord.user;\r\n  } catch (error) {\r\n    console.error(\"Error getting current user:\", error);\r\n    return null;\r\n  }\r\n}\r\n\r\nexport async function getUserUsageCount(userId: string): Promise<number> {\r\n  try {\r\n    const count = await prisma.usage.count({\r\n      where: { userId },\r\n    });\r\n    return count;\r\n  } catch (error) {\r\n    console.error(\"Error getting usage count:\", error);\r\n    return 0;\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n"],"names":[],"mappings":";;;;;;AACA;;AAEO,eAAe,eAAe,GAAgB;IACnD,MAAM,QAAQ,IAAI,OAAO,CAAC,GAAG,CAAC,cAAc;IAE5C,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IAEA,IAAI;QACF,yBAAyB;QACzB,MAAM,cAAc,MAAM,+IAAM,CAAC,KAAK,CAAC,UAAU,CAAC;YAChD,OAAO;gBAAE;YAAM;YACf,SAAS;gBAAE,MAAM;YAAK;QACxB;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO;QACT;QAEA,4BAA4B;QAC5B,IAAI,IAAI,SAAS,YAAY,SAAS,EAAE;YACtC,uBAAuB;YACvB,MAAM,+IAAM,CAAC,KAAK,CAAC,MAAM,CAAC;gBAAE,OAAO;oBAAE,IAAI,YAAY,EAAE;gBAAC;YAAE;YAC1D,OAAO;QACT;QAEA,OAAO,YAAY,IAAI;IACzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,+BAA+B;QAC7C,OAAO;IACT;AACF;AAEO,eAAe,kBAAkB,MAAc;IACpD,IAAI;QACF,MAAM,QAAQ,MAAM,+IAAM,CAAC,KAAK,CAAC,KAAK,CAAC;YACrC,OAAO;gBAAE;YAAO;QAClB;QACA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,8BAA8B;QAC5C,OAAO;IACT;AACF","debugId":null}},
    {"offset": {"line": 160, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Administrator/my-flux-saas/app/api/create-portal-session/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport Stripe from \"stripe\";\r\nimport { prisma } from \"../../../lib/prisma\";\r\nimport { getCurrentUser } from \"../../../lib/auth\";\r\n\r\nconst stripe = new Stripe(process.env.STRIPE_SECRET_KEY as string, {\r\n  apiVersion: (\"2022-11-15\" as any)\r\n});\r\n\r\nexport async function POST(req: NextRequest) {\r\n  try {\r\n    const user = await getCurrentUser(req);\r\n    if (!user) return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 });\r\n\r\n    // ðŸ‘‰ Fetch latest Payment row for this user\r\n    const lastPayment = await prisma.payment.findFirst({\r\n      where: { userId: user.id },\r\n      orderBy: { createdAt: \"desc\" }\r\n    });\r\n\r\n    if (!lastPayment) {\r\n      return NextResponse.json({\r\n        error: \"No payment record found for this user.\"\r\n      }, { status: 400 });\r\n    }\r\n\r\n    const customerId = lastPayment.stripeCustomerId;\r\n\r\n    if (!customerId) {\r\n      return NextResponse.json({\r\n        error: \"No Stripe customerId in last payment row.\"\r\n      }, { status: 400 });\r\n    }\r\n\r\n    const origin =\r\n      req.headers.get(\"origin\") ||\r\n      process.env.NEXT_PUBLIC_APP_URL ||\r\n      \"http://localhost:3000\";\r\n\r\n    // Create billing portal session\r\n    const session = await stripe.billingPortal.sessions.create({\r\n      customer: customerId,\r\n      return_url: `${origin}/account`,\r\n    });\r\n\r\n    return NextResponse.json({ url: session.url });\r\n  } catch (err) {\r\n    console.error(\"create-portal-session error:\", err);\r\n    return NextResponse.json(\r\n      { error: \"Failed to create portal session\" },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEA,MAAM,SAAS,IAAI,yLAAM,CAAC,QAAQ,GAAG,CAAC,iBAAiB,EAAY;IACjE,YAAa;AACf;AAEO,eAAe,KAAK,GAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,IAAA,qJAAc,EAAC;QAClC,IAAI,CAAC,MAAM,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAe,GAAG;YAAE,QAAQ;QAAI;QAE7E,4CAA4C;QAC5C,MAAM,cAAc,MAAM,+IAAM,CAAC,OAAO,CAAC,SAAS,CAAC;YACjD,OAAO;gBAAE,QAAQ,KAAK,EAAE;YAAC;YACzB,SAAS;gBAAE,WAAW;YAAO;QAC/B;QAEA,IAAI,CAAC,aAAa;YAChB,OAAO,sKAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,aAAa,YAAY,gBAAgB;QAE/C,IAAI,CAAC,YAAY;YACf,OAAO,sKAAY,CAAC,IAAI,CAAC;gBACvB,OAAO;YACT,GAAG;gBAAE,QAAQ;YAAI;QACnB;QAEA,MAAM,SACJ,IAAI,OAAO,CAAC,GAAG,CAAC,aAChB,QAAQ,GAAG,CAAC,mBAAmB,IAC/B;QAEF,gCAAgC;QAChC,MAAM,UAAU,MAAM,OAAO,aAAa,CAAC,QAAQ,CAAC,MAAM,CAAC;YACzD,UAAU;YACV,YAAY,GAAG,OAAO,QAAQ,CAAC;QACjC;QAEA,OAAO,sKAAY,CAAC,IAAI,CAAC;YAAE,KAAK,QAAQ,GAAG;QAAC;IAC9C,EAAE,OAAO,KAAK;QACZ,QAAQ,KAAK,CAAC,gCAAgC;QAC9C,OAAO,sKAAY,CAAC,IAAI,CACtB;YAAE,OAAO;QAAkC,GAC3C;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}